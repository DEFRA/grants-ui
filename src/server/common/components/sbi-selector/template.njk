{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}

{{ govukPhaseBanner({
  tag: {
    text: "Development",
    classes: "govuk-tag--red"
  },
  html: 'Single business identifier (SBI): ' + 
        '<input 
            type="text" 
            id="sbi-input"
            name="sbi"
            value="' + params.sbi + '" 
          />
          <span id="sbi-status" class="sbi-status" style="margin-left: 10px; font-size: 14px;"></span>'
}) }}

<script>
  (function() {
    const sbiInput = document.getElementById('sbi-input');
    const sbiStatus = document.getElementById('sbi-status');
    let debounceTimer;

    if (sbiInput) {
      sbiInput.addEventListener('input', function(e) {
        const newSbiValue = e.target.value;
        clearTimeout(debounceTimer);
        
        sbiStatus.textContent = 'Updating...';
        sbiStatus.style.color = '#666';
        
        debounceTimer = setTimeout(function() {
          updateSbi(newSbiValue);
        }, 1000);
      });

      function updateSbi(sbiValue) {     
        const csrfToken = document.querySelector('#csrf-token')?.value;
  
        if (!csrfToken) {
          console.error('CSRF token not found');
          return;
        }

        fetch('/api/update-sbi', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ 
            sbi: sbiValue,
            crumb: csrfToken
          })
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error('Network response was not ok');
        })
        .then(data => {
          sbiStatus.textContent = 'Saved';
          sbiStatus.style.color = '#00703c';
          
          setTimeout(() => {
            // redirect to start page
            window.location.replace('/find-funding-for-land-or-farms/start'); 
          }, 1000);

          setTimeout(() => {
            sbiStatus.textContent = '';
          }, 2000);
        })
        .catch(error => {
          console.error('Error updating SBI:', error);
          sbiStatus.textContent = 'Error saving';
          sbiStatus.style.color = '#d4351c';
          
          // Clear error status after 3 seconds
          setTimeout(() => {
            sbiStatus.textContent = '';
          }, 3000);
        });
      }
    }
  })();
</script>
